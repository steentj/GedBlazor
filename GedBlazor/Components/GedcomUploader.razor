@using Microsoft.AspNetCore.Components.Forms
@using GedBlazor.Models
@using GedBlazor.Parsers
@inject IGedcomParser Parser

<div class="gedcom-uploader container-fluid px-1">
    <h2>GEDCOM Viewer</h2>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @errorMessage
        </div>
    }

    <div class="row">
        <div class="col-12">
            <InputFile OnChange="@HandleFileSelected" class="form-control" accept=".ged" />
            <p class="mt-2">Drop GEDCOM file here or click to select (.ged files only)</p>
        </div>
    </div>

    @if (individuals?.Count > 0)
    {
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="probandSelect" class="form-label">Select Proband (root ancestor):</label>
                <select id="probandSelect" class="form-select" @onchange="OnProbandChanged">
                    <option value="">-- Select --</option>
                    @foreach (var ind in individuals.Values.OrderBy(i => i.FullName))
                    {
                        <option value="@ind.Id" selected="@(ind.Id == probandId ? "selected" : null)">@ind.FullName</option>
                    }
                </select>
            </div>
        </div>
        <div class="table-responsive" style="margin-left:0.5rem;margin-right:0.5rem;">
            <table class="table table-striped custom-zebra-table w-100 mt-4">
                <thead>
                    <tr>
                        <th style="width: 7%;" @onclick='() => SortBy("Anenummer")'>Anenummer</th>
                        <th style="width: 23%;" @onclick='() => SortBy("FullName")'>Name</th>
                        <th style="width: 23%;" @onclick='() => SortBy("BirthDate")'>Birth</th>
                        <th style="width: 23%;" @onclick='() => SortBy("DeathDate")'>Death</th>
                        <th style="width: 24%;" @onclick='() => SortBy("Father")'>Father / Mother</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var individual in GetSortedIndividuals().Select((ind, idx) => new { ind, idx }))
                    {
                        var rowClass = (individual.idx % 2 == 1) ? "even-row" : string.Empty;
                        <tr class="@rowClass">
                            <td class="align-top">@(individual.ind.Anenummer > 0 ? individual.ind.Anenummer.ToString() : "")</td>
                            <td class="align-top">@individual.ind.FullName</td>
                            <td>
                                @if (individual.ind.BirthDate != null || !string.IsNullOrEmpty(individual.ind.BirthPlace))
                                {
                                    <div class="fw-medium">@(individual.ind.BirthDate?.ToString() ?? "")</div>
                                    @if (!string.IsNullOrEmpty(individual.ind.BirthPlace))
                                    {
                                        <div class="text-muted small text-wrap">@individual.ind.BirthPlace</div>
                                    }
                                }
                            </td>
                            <td>
                                @if (individual.ind.DeathDate != null || !string.IsNullOrEmpty(individual.ind.DeathPlace))
                                {
                                    <div class="fw-medium">@(individual.ind.DeathDate?.ToString() ?? "")</div>
                                    @if (!string.IsNullOrEmpty(individual.ind.DeathPlace))
                                    {
                                        <div class="text-muted small text-wrap">@individual.ind.DeathPlace</div>
                                    }
                                }
                            </td>
                            <td>
                                @{
                                    var father = !string.IsNullOrEmpty(individual.ind.FatherId) && individuals.TryGetValue(individual.ind.FatherId, out var f) ? f.FullName : null;
                                    var mother = !string.IsNullOrEmpty(individual.ind.MotherId) && individuals.TryGetValue(individual.ind.MotherId, out var m) ? m.FullName : null;
                                }
                                <div>@father</div>
                                <div>@mother</div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private Dictionary<string, Individual>? individuals;
    private string? errorMessage;
    private string? probandId;
    private string sortColumn = "GivenName";
    private bool sortAscending = true;

    private IEnumerable<Individual> GetSortedIndividuals()
    {
        if (individuals == null)
            return Enumerable.Empty<Individual>();
        var list = individuals.Values.AsEnumerable();
        return (sortColumn, sortAscending) switch
        {
            ("Anenummer", true) => list.OrderBy(i => i.Anenummer == -1 ? int.MaxValue : i.Anenummer),
            ("Anenummer", false) => list.OrderByDescending(i => i.Anenummer == -1 ? int.MinValue : i.Anenummer),
            ("FullName", true) => list.OrderBy(i => i.FullName),
            ("FullName", false) => list.OrderByDescending(i => i.FullName),
            ("BirthDate", true) => list.OrderBy(i => i.BirthDate),
            ("BirthDate", false) => list.OrderByDescending(i => i.BirthDate),
            ("DeathDate", true) => list.OrderBy(i => i.DeathDate),
            ("DeathDate", false) => list.OrderByDescending(i => i.DeathDate),
            ("Father", true) => list.OrderBy(i => i.FatherId != null && individuals.TryGetValue(i.FatherId, out var f) ? f.FullName : ""),
            ("Father", false) => list.OrderByDescending(i => i.FatherId != null && individuals.TryGetValue(i.FatherId, out var f) ? f.FullName : ""),
            ("Mother", true) => list.OrderBy(i => i.MotherId != null && individuals.TryGetValue(i.MotherId, out var m) ? m.FullName : ""),
            ("Mother", false) => list.OrderByDescending(i => i.MotherId != null && individuals.TryGetValue(i.MotherId, out var m) ? m.FullName : ""),
            _ => list.OrderBy(i => i.FullName),
        };
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
            sortAscending = !sortAscending;
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            errorMessage = null;
            var file = e.File;

            if (!file.Name.EndsWith(".ged", StringComparison.OrdinalIgnoreCase))
            {
                errorMessage = "Please select a valid GEDCOM file (.ged)";
                return;
            }

            using var reader = new StreamReader(file.OpenReadStream());
            var content = await reader.ReadToEndAsync();
            (individuals, _) = Parser.Parse(content);
            probandId = null;
            if (individuals != null)
                Parser.AssignAnenummer(individuals, null);
            if (individuals == null || individuals.Count == 0)
            {
                errorMessage = "No individuals found in the GEDCOM file";
            }
        }
        catch (FormatException)
        {
            errorMessage = "Invalid GEDCOM file format";
            individuals = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error processing file: {ex.Message}";
            individuals = null;
        }
    }

    private void OnProbandChanged(ChangeEventArgs e)
    {
        probandId = e.Value?.ToString();
        if (individuals != null && !string.IsNullOrEmpty(probandId))
            Parser.AssignAnenummer(individuals, probandId);
        else if (individuals != null)
            Parser.AssignAnenummer(individuals, null);
    }
}