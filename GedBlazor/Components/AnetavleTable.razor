@using GedBlazor.Models
@using GedBlazor.Services
@inject IWordDocumentService WordDocumentService
@inject IFileDownloadService FileDownloadService

@if (Proband == null || Individuals == null)
{
    <div class="alert alert-info" role="alert">Vælg venligst en proband for at se anetavlen.</div>
}
else
{
    <div class="anetavle-actions mb-3">
        <button class="btn btn-primary" @onclick="DownloadAsWord" disabled="@isDownloading">
            @if (isDownloading)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span> Opretter dokument...</span>
            }
            else
            {
                <span>Download som Word (.docx)</span>
            }
        </button>
    </div>

    <div class="anetavle-container">
        <div class="anetavle" aria-label="Anetavle">
            <div class="generation proband" aria-label="Proband">
                <AnetavleCell Individual="@Proband" Anenummer="@Start" HighlightRole="proband" />
            </div>
        <div class="generation parents" aria-label="Forældre-generation">
            <AnetavleCell Individual="@GetAncestor(2 * Start)" Anenummer="@(2 * Start)" HighlightRole="parent" />
            <AnetavleCell Individual="@GetAncestor(2 * Start + 1)" Anenummer="@(2 * Start + 1)" HighlightRole="parent" />
        </div>
        <div class="generation grandparents" aria-label="Bedsteforældre-generation">
            <AnetavleCell Individual="@GetAncestor(4 * Start)" Anenummer="@(4 * Start)" />
            <AnetavleCell Individual="@GetAncestor(4 * Start + 1)" Anenummer="@(4 * Start + 1)" />
            <AnetavleCell Individual="@GetAncestor(4 * Start + 2)" Anenummer="@(4 * Start + 2)" />
            <AnetavleCell Individual="@GetAncestor(4 * Start + 3)" Anenummer="@(4 * Start + 3)" />
        </div>
        <div class="generation great-grandparents" aria-label="Oldeforældre-generation">
            <AnetavleCell Individual="@GetAncestor(8 * Start)" Anenummer="@(8 * Start)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(8 * Start + 1)" Anenummer="@(8 * Start + 1)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(8 * Start + 2)" Anenummer="@(8 * Start + 2)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(8 * Start + 3)" Anenummer="@(8 * Start + 3)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(8 * Start + 4)" Anenummer="@(8 * Start + 4)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(8 * Start + 5)" Anenummer="@(8 * Start + 5)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(8 * Start + 6)" Anenummer="@(8 * Start + 6)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(8 * Start + 7)" Anenummer="@(8 * Start + 7)" ShowMinimal="true" />
        </div>
        <div class="generation great-great-grandparents" aria-label="Tipoldeforældre-generation">
            <AnetavleCell Individual="@GetAncestor(16 * Start)" Anenummer="@(16 * Start)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 1)" Anenummer="@(16 * Start + 1)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 2)" Anenummer="@(16 * Start + 2)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 3)" Anenummer="@(16 * Start + 3)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 4)" Anenummer="@(16 * Start + 4)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 5)" Anenummer="@(16 * Start + 5)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 6)" Anenummer="@(16 * Start + 6)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 7)" Anenummer="@(16 * Start + 7)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 8)" Anenummer="@(16 * Start + 8)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 9)" Anenummer="@(16 * Start + 9)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 10)" Anenummer="@(16 * Start + 10)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 11)" Anenummer="@(16 * Start + 11)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 12)" Anenummer="@(16 * Start + 12)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 13)" Anenummer="@(16 * Start + 13)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 14)" Anenummer="@(16 * Start + 14)" ShowMinimal="true" />
            <AnetavleCell Individual="@GetAncestor(16 * Start + 15)" Anenummer="@(16 * Start + 15)" ShowMinimal="true" />
        </div>
        </div>
    </div>
}

@code {
    /// <summary>
    /// The individual (proband) for which to display the ancestor table.
    /// </summary>
    [Parameter]
    public Individual? Proband { get; set; }
    
    /// <summary>
    /// Dictionary of all individuals in the GEDCOM file.
    /// </summary>
    [Parameter]
    public Dictionary<string, Individual>? Individuals { get; set; }

    /// <summary>
    /// Flag to indicate if document download is in progress
    /// </summary>
    private bool isDownloading = false;

    private int Start => Proband != null && Proband.Anenummer > 0 ? Proband.Anenummer : 1;

    /// <summary>
    /// Finds an individual with the specified Anenummer.
    /// </summary>
    /// <param name="anenummer">The Anenummer to search for.</param>
    /// <returns>The individual with the specified Anenummer or null if not found.</returns>
    private Individual? GetAncestor(int anenummer)
    {
        if (Individuals == null) return null;
        return Individuals.Values.FirstOrDefault(i => i.Anenummer == anenummer);
    }

    /// <summary>
    /// Handles the download of the Anetavle as a Word document
    /// </summary>
    private async Task DownloadAsWord()
    {
        if (Proband == null || Individuals == null) return;
        
        try
        {
            isDownloading = true;
            
            // Generate the Word document
            var documentBytes = WordDocumentService.GenerateAnetavleDocument(Proband, Individuals);
            
            // Format file name: Anetavle-[ProbandName]-[Date].docx
            var sanitizedName = new string(
                Proband.FullName.Select(c => char.IsLetterOrDigit(c) || c == ' ' ? c : '_').ToArray()
            ).Replace(" ", "-");
            var fileName = $"Anetavle-{sanitizedName}-{DateTime.Now:yyyy-MM-dd}.docx";
            
            // Trigger the download
            await FileDownloadService.DownloadFileAsync(fileName, documentBytes);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error generating Word document: {ex.Message}");
            // In a real application, you might want to show an error message to the user
        }
        finally
        {
            isDownloading = false;
        }
    }
}

<style>
.anetavle-container {
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    padding: 0.5rem 0;
}

.anetavle {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
    align-items: center;
    min-width: 1200px; /* Ensure minimum width to prevent wrapping */
}

.anetavle-actions {
    display: flex;
    justify-content: flex-end;
    width: 100%;
    padding: 0 1rem;
}

.generation {
    display: flex;
    gap: 1rem;
    justify-content: center;
    width: 100%;
}

.great-grandparents {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 0.5rem;
}

.great-great-grandparents {
    display: grid;
    grid-template-columns: repeat(16, 1fr);
    gap: 0.5rem;
}

.grandparents {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
}

.parents {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.proband {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    width: 25%;
}

/* Progressive scaling for smaller screens - moderate font reduction */
@@media (max-width: 768px) {
    .anetavle {
        min-width: 1000px;
        font-size: 0.9rem;
        gap: 0.8rem;
        padding: 0.8rem;
    }
    
    .generation {
        gap: 0.8rem;
    }
    
    .great-grandparents {
        gap: 0.4rem;
    }
    
    .great-great-grandparents {
        gap: 0.4rem;
    }
    
    .grandparents {
        gap: 0.6rem;
    }
    
    .parents {
        gap: 0.8rem;
    }
}

@@media (max-width: 576px) {
    .anetavle {
        min-width: 900px;
        font-size: 0.85rem;
        gap: 0.7rem;
        padding: 0.7rem;
    }
    
    .generation {
        gap: 0.7rem;
    }
    
    .great-grandparents {
        gap: 0.3rem;
    }
    
    .great-great-grandparents {
        gap: 0.3rem;
    }
    
    .grandparents {
        gap: 0.5rem;
    }
    
    .parents {
        gap: 0.7rem;
    }
}

@@media (max-width: 480px) {
    .anetavle {
        min-width: 800px;
        font-size: 0.8rem;
        gap: 0.6rem;
        padding: 0.6rem;
    }
    
    .generation {
        gap: 0.6rem;
    }
    
    .great-grandparents {
        gap: 0.25rem;
    }
    
    .great-great-grandparents {
        gap: 0.25rem;
    }
    
    .grandparents {
        gap: 0.4rem;
    }
    
    .parents {
        gap: 0.6rem;
    }
}
</style>
